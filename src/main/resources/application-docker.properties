# ========================================
# Configuración para entorno Docker
# ========================================

# Nombre de la aplicación
spring.application.name=ventas-service

# Puerto del servicio (expuesto en el contenedor)
server.port=8083
server.address=0.0.0.0

# ========================================
# BASE DE DATOS (MySQL)
# ========================================
# Valores por defecto alineados a docker-compose-full
# Puede sobreescribirse por variables de entorno VENTAS_DATASOURCE_*
spring.datasource.url=${VENTAS_DATASOURCE_URL:jdbc:mysql://catalogo-mysql:3306/almacen_ventas?createDatabaseIfNotExist=true&serverTimezone=UTC&useSSL=false&allowPublicKeyRetrieval=true}
spring.datasource.driverClassName=com.mysql.cj.jdbc.Driver
spring.datasource.username=${VENTAS_DATASOURCE_USERNAME:almacen}
spring.datasource.password=${VENTAS_DATASOURCE_PASSWORD:almacen}

# JPA / Hibernate
spring.jpa.database-platform=org.hibernate.dialect.MySQLDialect
spring.jpa.hibernate.ddl-auto=validate
spring.jpa.show-sql=false
spring.sql.init.mode=never

# Flyway
spring.flyway.enabled=true
spring.flyway.locations=classpath:db/migration
spring.flyway.validate-on-migrate=true
spring.flyway.baseline-on-migrate=true
spring.flyway.baseline-version=1
spring.flyway.schemas=almacen_ventas
spring.flyway.default-schema=almacen_ventas

# ========================================
# LOGGING
# ========================================
logging.level.root=INFO
logging.level.unrn=DEBUG
logging.level.org.springframework.web.servlet.mvc.method.annotation=TRACE
logging.level.org.springframework.boot.autoconfigure=DEBUG
logging.level.org.flywaydb=INFO
logging.pattern.console=%d{yyyy-MM-dd HH:mm:ss} - %logger{36} - %msg%n
logging.charset.console=UTF-8

# ========================================
# SEGURIDAD - OAuth2 JWT (Keycloak)
# ========================================
spring.security.oauth2.resourceserver.jwt.issuer-uri=http://keycloak-sso:8080/realms/videoclub
spring.security.oauth2.resourceserver.jwt.jwk-set-uri=http://keycloak-sso:8080/realms/videoclub/protocol/openid-connect/certs

# ========================================
# INTEGRACIÓN CON OTRAS VERTICALES
# ========================================
# URLs de servicios externos (usar nombres de contenedor Docker)
# Ejemplo: para comunicarse con el catálogo usar el nombre del servicio docker
# catalogo.service.url=http://catalogo-backend:8080
# rating.service.url=http://rating-service:8082

# RabbitMQ
spring.rabbitmq.host=shared-rabbitmq
spring.rabbitmq.port=5672
spring.rabbitmq.username=guest
spring.rabbitmq.password=guest
spring.rabbitmq.publisher-confirm-type=correlated
spring.rabbitmq.publisher-returns=true
spring.rabbitmq.template.mandatory=true

rabbitmq.ventas.events.exchange=ventas.events
rabbitmq.ventas.compra.confirmada.routing-key=ventas.compra.confirmada
rabbitmq.catalogo.events.exchange=catalogo.events
rabbitmq.ventas.stock.rechazado.queue=ventas.q.catalogo-stock-rechazado
rabbitmq.catalogo.stock.rechazado.routing-key=catalogo.stock.rechazado
rabbitmq.ventas.retry.exchange=ventas.retry.exchange
rabbitmq.ventas.dlx.exchange=ventas.dlx.exchange
rabbitmq.ventas.stock.rechazado.retry.queue=ventas.q.catalogo-stock-rechazado.retry
rabbitmq.ventas.stock.rechazado.retry.routing-key=ventas.stock.rechazado.retry
rabbitmq.ventas.stock.rechazado.retry.ttl-ms=10000
rabbitmq.ventas.stock.rechazado.dlq.queue=ventas.q.catalogo-stock-rechazado.dlq
rabbitmq.ventas.stock.rechazado.dlq.routing-key=ventas.stock.rechazado.dlq
rabbitmq.ventas.stock.rechazado.max-retries=3
rabbitmq.event.movie.queue.name=ventas.movie.queue
rabbitmq.event.movie.routing-key=Movie.#
rabbitmq.publisher.confirm-timeout-ms=5000
rabbitmq.publisher.strict-confirms=true

# Outbox
ventas.outbox.scheduler.enabled=true
ventas.outbox.scheduler.delay-ms=3000
ventas.outbox.max-attempts=10
ventas.outbox.retry.base-delay-ms=2000

# ========================================
# ACTUATOR (para healthcheck)
# ========================================
management.endpoints.web.exposure.include=health,info
management.endpoint.health.show-details=when_authorized
management.health.db.enabled=true
management.health.rabbit.enabled=true

# Projection bootstrap
ventas.catalogo.base-url=${VENTAS_CATALOGO_BASE_URL:http://catalogo-backend:8080}
ventas.catalogo.page-size=${VENTAS_CATALOGO_PAGE_SIZE:200}
ventas.bootstrap.internal-token=${VENTAS_BOOTSTRAP_INTERNAL_TOKEN:changeme-bootstrap-token}
